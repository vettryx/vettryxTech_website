name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      # 1. PEGAR O CÃ“DIGO
      - name: ðŸšš Get latest code
        uses: actions/checkout@v4

      # 2. INSTALAR NODE
      - name: ðŸŸ¢ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. INSTALAR DEPENDÃŠNCIAS
      - name: ðŸ“¦ Install Dependencies
        run: npm install

      # 4. CONSTRUIR O SITE
      - name: ðŸ—ï¸ Build Site
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      # 5. PREPARAR PASTA PARA ENVIO
      - name: ðŸ—‚ï¸ Prepare Dist Folder
        run: |
          mkdir -p dist
          # Copia o site Next.js
          cp -r out/* dist/ || echo "out/ vazio ou inexistente"

          mkdir -p dist/images
          cp -r public/images/* dist/images/ 2>/dev/null || echo "Sem imagens em public/images"
          cp -r public/* dist/ 2>/dev/null || echo "Outros arquivos pÃºblicos"
          
          # Copia o backend da raiz
          cp backend/*.php dist/
          
          # Cria a pasta admin e copia os arquivos dela
          mkdir -p dist/admin
          cp backend/admin/*.php dist/admin/
          
          # --- CORREÃ‡ÃƒO: COPIAR A PASTA INCLUDES ---
          cp -r backend/admin/includes dist/admin/
          
          # Cria a pasta de uploads
          mkdir -p dist/uploads

      # 6. UPLOAD VIA LFTP
      - name: ðŸš€ Upload via LFTP
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp
          lftp -e "set ssl:verify-certificate no; open ${{ secrets.FTP_SERVER }}; user ${{ secrets.FTP_USERNAME }} ${{ secrets.FTP_PASSWORD }}; mirror -R --verbose --parallel=2 ./dist /public_html; bye"